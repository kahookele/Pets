<style>
    /* CSS variables from :root in base.html are available here */

    .sidebar {
        height: 100%; /* Fills the .sidebar-column which has the 100vh and border */
        background-color: var(--main-bg-color); 
        color: var(--primary-text-color); 
        width: 100%; 
        padding: 20px 10px 15px 10px;
        position: relative; 
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        transition: width 0.35s ease-in-out; 
    }

    /* Narrow state for the main .sidebar div */
    .sidebar.narrow {
        width: var(--sidebar-actual-width-narrow) !important; 
    }
    .sidebar.narrow .sidebar-label {
        opacity: 0;
        max-width: 0;
        font-size: 0;
        overflow: hidden;
        margin-left: -10px; 
        padding: 0;
        white-space: normal;
    }
    .sidebar.narrow .sidebar-title { 
        font-size: 1rem; 
        padding: 0 5px 10px 5px;
        margin-bottom: 15px;
        opacity: 0; 
        max-height: 0;
        overflow: hidden;
    }
    .sidebar.narrow a#searchIconToggle, 
    .sidebar.narrow li a { 
        justify-content: center;
        gap: 0;
        padding-left: 5px;
        padding-right: 5px;
    }
     .sidebar.narrow .sidebar-dog-item {
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        padding:0; margin:0;
    }

    .sidebar-title {
        font-size: 1.8rem; 
        font-weight: 600; 
        color: var(--primary-text-color); 
        padding: 0 5px 10px 5px;
        width: 100%;
        text-align: center;
        user-select: none;
        margin-bottom: 25px;
        box-sizing: border-box;
        line-height: 1.1;
        transition: font-size 0.35s ease-in-out, padding 0.35s ease-in-out, margin-bottom 0.35s ease-in-out, opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
    }

    .sidebar ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .sidebar li {
        width: 100%;
        margin-bottom: 5px;
    }

    .sidebar a {
        color: var(--primary-text-color); /* Default text color for sidebar items */
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        border-radius: 25px; 
        overflow: hidden; 
        text-overflow: ellipsis;
        box-sizing: border-box;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, padding 0.35s ease-in-out, gap 0.35s ease-in-out, justify-content 0.35s ease-in-out;
        gap: 12px;
        cursor: pointer;
    }

    .sidebar a:hover {
        background-color: var(--general-hover-bg-color); /* Light gray background on hover */
        color: var(--hover-text-color); /* Primary text color on hover */
    }
    
    .sidebar a.active {
        background-color: var(--active-selection-bg-color); /* Light gray background for active item */
        color: var(--active-selection-text-color); /* Blue text for active item for emphasis */
        font-weight: 600; /* Slightly bolder for active item */
    }
    
    /* Ensure icons in active links also adopt the active text color */
    .sidebar a.active .sidebar-icon {
        color: var(--active-selection-text-color);
    }
    /* Ensure icons in hovered links adopt the hover text color */
    .sidebar a:hover .sidebar-icon {
        color: var(--hover-text-color);
    }


    .sidebar .sidebar-icon {
        min-width: 20px;
        max-width: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        opacity: 1;
        flex-shrink: 0; 
        transition: color 0.2s ease-in-out; /* Smooth color transition for icons */
    }

    .sidebar .sidebar-label {
        opacity: 1;
        transition: opacity 0.3s ease-in-out 0.05s, max-width 0.3s ease-in-out, font-size 0.3s ease-in-out; 
    }
    
    .sidebar-dog-item {
        margin-top: auto;
        margin-bottom: 0;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 10px;
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out, padding 0.3s ease-in-out, margin 0.3s ease-in-out;
    }
    
    /* Styles for notification badge */
    .sidebar .badge.bg-danger {
        background-color: var(--link-color) !important; 
        color: var(--main-bg-color) !important; 
    }

    #resultsListPanel { /* The UL holding the results */
    list-style-type: none;
    padding: 0;
    margin: 0;
    max-height: 300px; /* Example max height, adjust as needed */
    overflow-y: auto; /* Add scroll if results exceed max height */
    }

    .search-result-link {
        display: flex; /* Key for aligning image and text horizontally */
        align-items: center; /* Vertically aligns items in the center */
        padding: 8px 15px; /* Padding inside each result item */
        text-decoration: none;
        color: var(--primary-text-color, #333); /* Use your CSS variable or a default */
        transition: background-color 0.2s ease-in-out;
        border-bottom: 1px solid var(--border-color, #eee); /* Light border between items */
    }

    .search-result-item:last-child .search-result-link {
        border-bottom: none; /* No border for the last item */
    }

    .search-result-link:hover {
        background-color: var(--general-hover-bg-color, #f0f0f0); /* Use variable or default */
        color: var(--hover-text-color, #000);
    }

    .search-result-image {
        width: 35px;   /* Adjust size of the profile image */
        height: 35px;  /* Adjust size of the profile image */
        border-radius: 50%; /* Makes the image circular */
        margin-right: 12px; /* Space between image and username */
        object-fit: cover; /* Ensures the image covers the area without distortion */
        background-color: #f0f0f0; /* Fallback bg if image is transparent or slow loading */
    }

    .search-result-username {
        font-size: 0.9rem;
        font-weight: 500;
        /* Allow username to take remaining space and truncate if too long */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-no-results {
        padding: 10px 15px;
        color: #777;
        font-style: italic;
        text-align: center;
    }

</style>

<div class="sidebar" id="mainSidebar"> <div class="sidebar-title">Pets</div>
    <ul>
        <li>
            <a href="{{ url_for('home') }}" class="{{ 'active' if active_page == 'home' else '' }}">
                <span class="sidebar-icon"><i class="bi bi-house-door-fill"></i></span>
                <span class="sidebar-label">Home</span>
            </a>
        </li>

        <li class="search-toggle-item"> <a id="searchIconToggle"> <span class="sidebar-icon"><i class="bi bi-search"></i></span>
                <span class="sidebar-label" id="searchIconToggleLabel">Search</span> </a>
            </li>

        <li>
            <a href="{{ url_for('profile') }}" class="{{ 'active' if active_page == 'profile' else '' }}">
                <span class="sidebar-icon"><i class="fas fa-paw"></i></span>
                <span class="sidebar-label">Profile</span>
            </a>
        </li>
        <li>
            <a href="{{ url_for('notifications_page') }}" id="notificationsToggle" class="{{ 'active' if active_page == 'notifications' else '' }}">
                <span class="sidebar-icon"><i class="bi bi-hearts"></i></span>
                <span class="sidebar-label">
                    Notifications
                    {% if unread_notification_count > 0 %}
                        <span class="badge bg-danger ms-1">{{ unread_notification_count }}</span>
                    {% endif %}
                </span>
            </a>
        </li>
        <li>
            <a href="{{ url_for('messages_home') }}" class="{{ 'active' if active_page == 'messages' else '' }}">
                <span class="sidebar-icon"><i class="bi bi-envelope-fill"></i></span>
                <span class="sidebar-label">
                    Messages
                    {% if unread_message_count > 0 %}
                        <span class="badge bg-danger ms-1">{{ unread_message_count }}</span>
                    {% endif %}
                </span>
            </a>
        </li>
        <li class="sidebar-dog-item">
            {% include 'kaa.html' %}
        </li>
        <li>
            <a href="{{ url_for('logout') }}">
                <span class="sidebar-icon"><i class="bi bi-box-arrow-right"></i></span>
                <span class="sidebar-label">Logout</span>
            </a>
        </li>
    </ul>
</div>

<script>
  // Ensure this script runs after the DOM is fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    const mainSidebar = document.getElementById('mainSidebar');
    const searchIconToggle = document.getElementById('searchIconToggle');
    const searchPanel = document.getElementById('searchPanel');
    const panelSearchInput = document.getElementById('panelSearchInput');
    const liveResultsListPanel = document.getElementById('resultsListPanel');
    const recentsContainer = document.querySelector('.search-panel-recents');
    const recentSearchesUL = document.getElementById('recentSearchesList'); // Corrected ID
    const clearRecentsButton = document.getElementById('clearRecentsButton');
      const liveSearchResultsContainer = document.getElementById('liveSearchResultsContainer');

    const notificationsToggle = document.getElementById('notificationsToggle');
    const notificationsPanel = document.getElementById('notificationsPanel');
    const closeNotificationsPanel = document.getElementById('closeNotificationsPanel');
    const clearNotificationsPanelBtn = document.getElementById('clearNotificationsPanel');
    const notificationsList = document.getElementById('notificationsList');


    const RECENT_SEARCHES_KEY = 'petAppRecentSearches';
    const MAX_RECENT_SEARCHES = 7; // Max number of recent searches to store

    // --- Recent Searches Functions ---
    function loadRecentSearches() {
        const searches = localStorage.getItem(RECENT_SEARCHES_KEY);
        return searches ? JSON.parse(searches) : [];
    }

    function saveRecentSearches(searches) {
        localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(searches));
    }

    function addOrUpdateRecentSearch(user) { // user = {id, username, profile_pic}
        let recents = loadRecentSearches();
        // Remove if already exists to move it to the top
        recents = recents.filter(s => s.id !== user.id);
        // Add to the beginning
        recents.unshift(user);
        // Trim to max length
        if (recents.length > MAX_RECENT_SEARCHES) {
            recents = recents.slice(0, MAX_RECENT_SEARCHES);
        }
        saveRecentSearches(recents);
        displayRecentSearches(); // Re-render after adding/updating
    }

    function removeRecentSearch(userId) {
        let recents = loadRecentSearches();
        recents = recents.filter(s => s.id !== userId);
        saveRecentSearches(recents);
        displayRecentSearches();
    }

    function displayRecentSearches() {
        const recents = loadRecentSearches();
        recentSearchesUL.innerHTML = ''; // Clear current list

        if (recents.length === 0) {
            const noRecentsLi = document.createElement('li');
            noRecentsLi.textContent = 'No recent searches.';
            noRecentsLi.style.padding = '10px 0'; // Some basic styling for the message
            noRecentsLi.style.textAlign = 'center';
            noRecentsLi.style.color = 'var(--secondary-text-color)';
            recentSearchesUL.appendChild(noRecentsLi);
            if (recentsContainer) recentsContainer.style.display = 'block'; // Make sure recents area is visible
            if (liveSearchResultsContainer) liveSearchResultsContainer.style.display = 'none';
            return;
        }

        recents.forEach(s_user => {
            const listItem = document.createElement('li');
            // Use existing CSS classes from base.html for styling

            const link = document.createElement('a');
            link.href = `/profile/${s_user.username}`;
            link.style.display = 'flex'; // Make link behave like a block for full clickable area
            link.style.alignItems = 'center';
            link.style.width = '100%';
            link.style.textDecoration = 'none';
            link.style.padding = '8px 4px'; // Match hover style for items
            link.style.borderRadius = '4px';
            link.onmouseover = function() { this.style.backgroundColor = 'var(--general-hover-bg-color)'; };
            link.onmouseout = function() { this.style.backgroundColor = 'transparent'; };


            link.addEventListener('click', (e) => {
                // Update recent search order before navigating
                addOrUpdateRecentSearch(s_user);
                // Allow default navigation to proceed
            });

            const img = document.createElement('img');
            img.src = s_user.profile_pic || '/static/images/default_avatar.png';
            img.alt = s_user.username;
            img.classList.add('recent-avatar'); // CSS class from base.html
             img.onerror = function() { this.src = '/static/images/default_avatar.png'; };


            const infoDiv = document.createElement('div');
            infoDiv.classList.add('recent-info'); // CSS class from base.html

            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('recent-username'); // CSS class from base.html
            usernameSpan.textContent = s_user.username;
            usernameSpan.style.color = 'var(--primary-text-color)';


            const subtextSpan = document.createElement('span');
            subtextSpan.classList.add('recent-subtext'); // CSS class from base.html
            subtextSpan.textContent = "Profile"; // Or s_user.username, or a fetched full name if available
            subtextSpan.style.color = 'var(--secondary-text-color)';


            infoDiv.appendChild(usernameSpan);
            infoDiv.appendChild(subtextSpan);

            link.appendChild(img);
            link.appendChild(infoDiv);

            listItem.appendChild(link);

            const removeButton = document.createElement('button');
            removeButton.classList.add('recent-remove'); // CSS class from base.html
            removeButton.innerHTML = '×'; // '×' character
            removeButton.dataset.userId = s_user.id;
            removeButton.onclick = function(event) {
                event.stopPropagation(); // Prevent link navigation if 'x' is inside <a>
                removeRecentSearch(s_user.id);
            };

            listItem.appendChild(removeButton); // Append remove button next to the link within the li
            recentSearchesUL.appendChild(listItem);
        });
        if (recentsContainer) recentsContainer.style.display = 'block';
        if (liveSearchResultsContainer) liveSearchResultsContainer.style.display = 'none';
    }

    // --- Panel Open/Close Logic ---
    function openSearchPanel() {
        if (mainSidebar) mainSidebar.classList.add('narrow');
        if (searchPanel) searchPanel.classList.add('active');
        if (searchIconToggle) searchIconToggle.classList.add('active');
        if (panelSearchInput) panelSearchInput.focus();
        // When panel opens, show recents if input is empty
        if (panelSearchInput && panelSearchInput.value.length < 2) {
             displayRecentSearches();
             if (liveSearchResultsContainer) liveSearchResultsContainer.style.display = 'none';
             if (recentsContainer) recentsContainer.style.display = 'block';
        }
    }

      function closeSearchPanel() {
          if (mainSidebar) mainSidebar.classList.remove('narrow');
          if (searchPanel) searchPanel.classList.remove('active');
          if (searchIconToggle) searchIconToggle.classList.remove('active');
      }

      function fetchNotifications() {
          if (!notificationsList) return;
          notificationsList.innerHTML = '<li>Loading...</li>';
          fetch('/api/notifications')
            .then(res => res.json())
            .then(data => {
                notificationsList.innerHTML = '';
                if (data.length === 0) {
                    notificationsList.innerHTML = '<li>No notifications.</li>';
                } else {
                    data.forEach(notif => {
                        const li = document.createElement('li');
                        const linkStart = notif.link && notif.link !== '#' ? `<a href="${notif.link}">` : '';
                        const linkEnd = notif.link && notif.link !== '#' ? '</a>' : '';
                        const time = notif.timestamp ? new Date(notif.timestamp).toLocaleString() : '';
                        li.innerHTML = `${linkStart}${notif.message}${linkEnd}<br><small>${time}</small>`;
                        notificationsList.appendChild(li);
                    });
                }
            })
            .catch(() => {
                notificationsList.innerHTML = '<li>Error loading notifications.</li>';
            });
      }

      function openNotificationsPanel() {
          if (notificationsPanel) notificationsPanel.classList.add('active');
          fetchNotifications();
      }

      function closeNotificationsPanelFn() {
          if (notificationsPanel) notificationsPanel.classList.remove('active');
      }

      if (searchIconToggle) {
          searchIconToggle.addEventListener('click', function (event) {
              event.stopPropagation();
              if (searchPanel && searchPanel.classList.contains('active')) {
                  closeSearchPanel();
              } else {
                  openSearchPanel();
              }
          });
      }

      if (notificationsToggle) {
          notificationsToggle.addEventListener('click', function(event) {
              event.preventDefault();
              event.stopPropagation();
              if (notificationsPanel && notificationsPanel.classList.contains('active')) {
                  closeNotificationsPanelFn();
              } else {
                  openNotificationsPanel();
              }
          });
      }

      if (closeNotificationsPanel) {
          closeNotificationsPanel.addEventListener('click', function(event){
              event.stopPropagation();
              closeNotificationsPanelFn();
          });
      }

      if (clearNotificationsPanelBtn) {
          clearNotificationsPanelBtn.addEventListener('click', function(event){
              event.stopPropagation();
              fetch('/mark_all_notifications_read', {method: 'POST'})
                .then(() => { notificationsList.innerHTML = '<li>No notifications.</li>'; })
                .catch(() => console.error('Failed to clear notifications'));
              const badge = notificationsToggle ? notificationsToggle.querySelector('.badge') : null;
              if (badge) badge.remove();
          });
      }

    document.addEventListener('click', function(event) {
        if (searchPanel && searchPanel.classList.contains('active')) {
            const isClickInsideSearchPanel = searchPanel.contains(event.target);
            const isClickOnSearchIconToggle = searchIconToggle ? searchIconToggle.contains(event.target) : false;
            if (!isClickInsideSearchPanel && !isClickOnSearchIconToggle) {
                closeSearchPanel();
            }
        }
        if (notificationsPanel && notificationsPanel.classList.contains('active')) {
            const insideNotif = notificationsPanel.contains(event.target);
            const onToggle = notificationsToggle ? notificationsToggle.contains(event.target) : false;
            if (!insideNotif && !onToggle) {
                closeNotificationsPanelFn();
            }
        }
    });

    // --- Live Search & Input Handling ---
    if (panelSearchInput) {
        panelSearchInput.addEventListener('input', function () {
            const query = this.value.trim();

            if (query.length < 2) {
                liveResultsListPanel.innerHTML = '';
                if (liveSearchResultsContainer) liveSearchResultsContainer.style.display = 'none';
                if (recentsContainer) recentsContainer.style.display = 'block';
                displayRecentSearches(); // Show recents when query is short
                return;
            }

            if (recentsContainer) recentsContainer.style.display = 'none'; // Hide recents when typing
            if (liveSearchResultsContainer) liveSearchResultsContainer.style.display = 'block';


            fetch(`/search_users?q=${encodeURIComponent(query)}`)
              .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
              })
              .then(data => {
                liveResultsListPanel.innerHTML = '';
                if (data.length === 0) {
                    liveResultsListPanel.innerHTML = '<li class="search-no-results">No users found.</li>';
                } else {
                    data.forEach(user => { // user from backend: {id, username, profile_pic}
                        const listItem = document.createElement('li');
                        listItem.classList.add('search-result-item'); // Ensure you have styles for this

                        const link = document.createElement('a');
                        link.href = `/profile/${user.username}`;
                        link.classList.add('search-result-link'); // Existing class from sidebar.html for results

                        // Add user to recents when their profile is about to be visited
                        link.addEventListener('click', function() {
                            addOrUpdateRecentSearch({
                                id: user.id, // Make sure your backend search_users provides 'id'
                                username: user.username,
                                profile_pic: user.profile_pic
                            });
                        });

                        const img = document.createElement('img');
                        img.src = user.profile_pic || '/static/images/default_avatar.png';
                        img.alt = user.username;
                        img.classList.add('search-result-image');
                        img.onerror = function() { this.src = '/static/images/default_avatar.png'; };

                        const usernameSpan = document.createElement('span');
                        usernameSpan.textContent = user.username;
                        usernameSpan.classList.add('search-result-username');

                        link.appendChild(img);
                        link.appendChild(usernameSpan);
                        listItem.appendChild(link);
                        liveResultsListPanel.appendChild(listItem);
                    });
                }
              })
              .catch(error => {
                console.error("Error fetching search results:", error);
                liveResultsListPanel.innerHTML = '<li class="search-no-results">Error loading results.</li>';
              });
        });
    }

    // --- Recents Clear All Button ---
    if (clearRecentsButton) {
        clearRecentsButton.addEventListener('click', function() {
            saveRecentSearches([]); // Clear from localStorage
            displayRecentSearches(); // Re-render (will show "No recent searches")
        });
    }

    // --- Initial Display on Load (if panel might be open or for first open) ---
    // If the panel starts closed, this will run when it's first opened.
    // If the panel could start open, this ensures recents are shown.
    if (panelSearchInput && panelSearchInput.value.length < 2) {
        displayRecentSearches();
    } else {
        if (recentsContainer) recentsContainer.style.display = 'none';
    }
    if (liveResultsListPanel.innerHTML.trim() === '') { // if no live results initially
         if (liveSearchResultsContainer) liveSearchResultsContainer.style.display = 'none';
    }
  });
</script>