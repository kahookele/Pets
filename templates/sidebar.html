<style>
    /* CSS variables from :root in base.html are available here */

    .sidebar {
        height: 100%; /* Fills the .sidebar-column which has the 100vh and border */
        background-color: var(--main-bg-color); 
        color: var(--primary-text-color); 
        width: 100%; 
        padding: 20px 10px 15px 10px;
        position: relative; 
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
        transition: width 0.35s ease-in-out; 
    }

    /* Narrow state for the main .sidebar div */
    .sidebar.narrow {
        width: var(--sidebar-actual-width-narrow) !important; 
    }
    .sidebar.narrow .sidebar-label {
        opacity: 0;
        max-width: 0;
        font-size: 0;
        overflow: hidden;
        margin-left: -10px; 
        padding: 0;
        white-space: normal;
    }
    .sidebar.narrow .sidebar-title { 
        font-size: 1rem; 
        padding: 0 5px 10px 5px;
        margin-bottom: 15px;
        opacity: 0; 
        max-height: 0;
        overflow: hidden;
    }
    .sidebar.narrow a#searchIconToggle, 
    .sidebar.narrow li a { 
        justify-content: center;
        gap: 0;
        padding-left: 5px;
        padding-right: 5px;
    }
     .sidebar.narrow .sidebar-dog-item {
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        padding:0; margin:0;
    }

    .sidebar-title {
        font-size: 1.8rem; 
        font-weight: 600; 
        color: var(--primary-text-color); 
        padding: 0 5px 10px 5px;
        width: 100%;
        text-align: center;
        user-select: none;
        margin-bottom: 25px;
        box-sizing: border-box;
        line-height: 1.1;
        transition: font-size 0.35s ease-in-out, padding 0.35s ease-in-out, margin-bottom 0.35s ease-in-out, opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
    }

    .sidebar ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .sidebar li {
        width: 100%;
        margin-bottom: 5px;
    }

    .sidebar a {
        color: var(--primary-text-color); /* Default text color for sidebar items */
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        border-radius: 25px; 
        overflow: hidden; 
        text-overflow: ellipsis;
        box-sizing: border-box;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, padding 0.35s ease-in-out, gap 0.35s ease-in-out, justify-content 0.35s ease-in-out;
        gap: 12px;
        cursor: pointer;
    }

    .sidebar a:hover {
        background-color: var(--general-hover-bg-color); /* Light gray background on hover */
        color: var(--hover-text-color); /* Primary text color on hover */
    }
    
    .sidebar a.active {
        background-color: var(--active-selection-bg-color); /* Light gray background for active item */
        color: var(--active-selection-text-color); /* Blue text for active item for emphasis */
        font-weight: 600; /* Slightly bolder for active item */
    }
    
    /* Ensure icons in active links also adopt the active text color */
    .sidebar a.active .sidebar-icon {
        color: var(--active-selection-text-color);
    }
    /* Ensure icons in hovered links adopt the hover text color */
    .sidebar a:hover .sidebar-icon {
        color: var(--hover-text-color);
    }


    .sidebar .sidebar-icon {
        min-width: 20px;
        max-width: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        opacity: 1;
        flex-shrink: 0; 
        transition: color 0.2s ease-in-out; /* Smooth color transition for icons */
    }

    .sidebar .sidebar-label {
        opacity: 1;
        transition: opacity 0.3s ease-in-out 0.05s, max-width 0.3s ease-in-out, font-size 0.3s ease-in-out; 
    }
    
    .sidebar-dog-item {
        margin-top: auto;
        margin-bottom: 0;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 10px;
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out, padding 0.3s ease-in-out, margin 0.3s ease-in-out;
    }
    
    /* Styles for notification badge */
    .sidebar .badge.bg-danger {
        background-color: var(--link-color) !important; 
        color: var(--main-bg-color) !important; 
    }

</style>

<div class="sidebar" id="mainSidebar"> <div class="sidebar-title">Pets</div>
    <ul>
        <li>
            <a href="{{ url_for('home') }}" class="{{ 'active' if active_page == 'home' else '' }}">
                <span class="sidebar-icon"><i class="bi bi-house-door-fill"></i></span>
                <span class="sidebar-label">Home</span>
            </a>
        </li>

        <li class="search-toggle-item"> <a id="searchIconToggle"> <span class="sidebar-icon"><i class="bi bi-search"></i></span>
                <span class="sidebar-label" id="searchIconToggleLabel">Search</span> </a>
            </li>

        <li>
            <a href="{{ url_for('profile') }}" class="{{ 'active' if active_page == 'profile' else '' }}">
                <span class="sidebar-icon"><i class="fas fa-paw"></i></span>
                <span class="sidebar-label">Profile</span>
            </a>
        </li>
        <li>
            <a href="{{ url_for('notifications_page') }}" class="{{ 'active' if active_page == 'notifications' else '' }}">
                <span class="sidebar-icon"><i class="bi bi-hearts"></i></span>
                <span class="sidebar-label">
                    Notifications
                    {% if unread_notification_count > 0 %}
                        <span class="badge bg-danger ms-1">{{ unread_notification_count }}</span>
                    {% endif %}
                </span>
            </a>
        </li>
        <li>
            <a href="{{ url_for('direct_messages', conversation_id='user1_user2') }}" class="{{ 'active' if active_page == 'direct_messages' else '' }}">
                <span class="sidebar-icon"><i class="bi bi-envelope-fill"></i></span>
                <span class="sidebar-label">Messages</span>
            </a>
        </li>
        <li class="sidebar-dog-item">
            {% include 'kaa.html' %}
        </li>
        <li>
            <a href="{{ url_for('logout') }}">
                <span class="sidebar-icon"><i class="bi bi-box-arrow-right"></i></span>
                <span class="sidebar-label">Logout</span>
            </a>
        </li>
    </ul>
</div>

<script>
  // Ensure this script runs after the DOM is fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    const mainSidebar = document.getElementById('mainSidebar'); 
    const searchIconToggle = document.getElementById('searchIconToggle'); 
    const searchPanel = document.getElementById('searchPanel');     
    const panelSearchInput = document.getElementById('panelSearchInput'); 
    const liveResultsListPanel = document.getElementById('resultsListPanel'); // Ensure this ID matches the UL in base.html

    function openSearchPanel() {
        if (mainSidebar) mainSidebar.classList.add('narrow');
        if (searchPanel) searchPanel.classList.add('active');
        // The .active class on searchIconToggle will now pick up the sidebar's <a>.active styles
        if (searchIconToggle) searchIconToggle.classList.add('active'); 
        if (panelSearchInput) panelSearchInput.focus();
    }

    function closeSearchPanel() {
        if (mainSidebar) mainSidebar.classList.remove('narrow');
        if (searchPanel) searchPanel.classList.remove('active');
        if (searchIconToggle) searchIconToggle.classList.remove('active'); 
    }

    if (searchIconToggle) {
        searchIconToggle.addEventListener('click', function (event) {
            event.stopPropagation(); // Prevent click from bubbling to document
            if (searchPanel && searchPanel.classList.contains('active')) {
                closeSearchPanel();
            } else {
                openSearchPanel();
            }
        });
    }

    // Close search panel if clicking outside of it
    document.addEventListener('click', function(event) {
        if (searchPanel && searchPanel.classList.contains('active')) { 
            const isClickInsideSearchPanel = searchPanel.contains(event.target);
            // Check if the click was on the toggle button itself (or its children)
            const isClickOnSearchIconToggle = searchIconToggle ? searchIconToggle.contains(event.target) : false;

            if (!isClickInsideSearchPanel && !isClickOnSearchIconToggle) {
                closeSearchPanel();
            }
        }
    });

    // Live search functionality (assuming your backend /search_users endpoint exists)
    if (panelSearchInput) {
        panelSearchInput.addEventListener('input', function () {
            const query = this.value;
            const recentsContainer = document.querySelector('.search-panel-recents'); // From base.html
            
            if (liveResultsListPanel) { 
                if (query.length < 2) { // Only search if query is at least 2 chars
                    liveResultsListPanel.innerHTML = '';
                    if(recentsContainer) recentsContainer.style.display = 'block'; // Show recents
                    return; 
                }
                if(recentsContainer) recentsContainer.style.display = 'none'; // Hide recents when typing

                fetch(`/search_users?q=${encodeURIComponent(query)}`)
                  .then(res => {
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return res.json();
                  })
                  .then(data => {
                    liveResultsListPanel.innerHTML = ''; // Clear previous results
                    data.forEach(user => {
                      const listItem = document.createElement('li');
                      listItem.textContent = user.username; // Adjust if your user object has different properties
                      // Add click handler to go to user profile or similar
                      // listItem.onclick = () => { window.location.href = `/user/${user.username}`; };
                      liveResultsListPanel.appendChild(listItem);
                    });
                  })
                  .catch(error => {
                    console.error("Error fetching search results:", error);
                    liveResultsListPanel.innerHTML = '<li>Error loading results.</li>';
                  });
            }
        });
    }

    // Clear recents button functionality (assuming structure from base.html)
    const clearRecentsButton = document.getElementById('clearRecentsButton');
    if(clearRecentsButton) {
        clearRecentsButton.addEventListener('click', function() {
            const recentSearchesList = document.getElementById('recentSearchesList'); // From base.html
            if (recentSearchesList) recentSearchesList.innerHTML = '<li>Recent searches cleared.</li>';
            // Add logic here to actually clear them from storage if needed
        });
    }
    
    // Remove individual recent search item (assuming structure from base.html)
    const recentSearchesList = document.getElementById('recentSearchesList');
    if (recentSearchesList) {
        recentSearchesList.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('recent-remove')) {
                event.stopPropagation(); 
                event.target.closest('li').remove();
                // Add logic here to remove from storage if needed
            }
        });
    }
  });
</script>
